<div id="gallery-bidassoa" class="gallery container-xxl">
  {% assign items = site.data.bidassoa %}
  {% assign current_year = nil %}

  {% assign years = site.data.bidassoa | map: 'year' | uniq | sort | reverse %}

  <!-- Recopilar todos los keywords únicos -->
  {% assign all_keywords = "" | split: "" %}
  {% for item in items %}
  {% if item.keywords %}
  {% assign all_keywords = all_keywords | concat: item.keywords %}
  {% endif %}
  {% endfor %}
  {% assign unique_keywords = all_keywords | uniq | sort %}

  <aside class="gallery__navFilters">
    <!-- Keywords disponibles -->
    <div class="mb-4">
      <div class="d-flex mb-3">
        <h5 class="mb-0">Keywords</h5>
        <button id="clear-filters" class="btn btn-sm btn-link text-muted p-0 ms-3" style="display: none;" title="Clear all filters">
          <i class="bi bi-trash"></i>
        </button>
      </div>
      <div id="keywords-list" class="d-flex flex-wrap gap-2">
        {% for keyword in unique_keywords %}
        <a href="#keyword-{{ keyword | slugify }}"
          class="keyword-filter badge text-bg-light text-decoration-none fw-light"
          data-keyword="{{ keyword }}">{{ keyword }}</a>
        {% endfor %}
      </div>
    </div>
  </aside>

  <div class="gallery__content d-flex">

    <aside class="gallery__navYears py-4 order-2 ps-4  pt-4">
      <nav id="navbar-years" class="sticky-top text-end">
        <h5 class="mb-3">Years</h5>
        <ul class="fw-light ps-0 list-unstyled">
          {% for year in years %}
          <li class="ps-0"><a href="#year-{{ year }}">{{ year }}</a></li>
          {% endfor %}
        </ul>
      </nav>
    </aside>

    <div class="gallery__grid flex-grow-1">

      {% for item in items %}

      {% if item.year != current_year %}
      {% if forloop.index0 > 0 %}
      </section> <!-- /.bidassoa-year-grid -->
      {% endif %}

      {% assign current_year = item.year %}


      <section id="year-{{ item.year }}" class="gallery__year">
        <header class="gallery__year__header d-flex justify-content-between">
          <h2 class="gallery__year__title fw-light">{{ current_year }}</h2>
          <a href="#gallery-bidassoa" class="link-opacity-10 link-opacity-100-hover"><i class="bi bi-arrow-bar-up"></i>
            <div class="visually-hidden">Back to top</div>
          </a>
        </header>
        {% endif %}

        {% assign group_id = item.id | slugify %}

        {% capture caption_html %}
        <div class="gallery__item__caption">
          <div class="gallery__item__caption__title fw-lighter lead">"{{ item.title | default: item.alias | capitalize }}"</div>
          <div class="gallery__item__caption__year fw-lighter">{{ item.year }}</div>
        </div>

          {% if  item.notes != "" or item.keywords.size > 0  %}
          <div class="gallery__item__caption__meta">
            {% if item.notes != "" %}
            <div class="gallery__item__caption__notes mt-3 fw-lighter">
              <h3 class="h6"><i class="bi bi-journal-text d-inline"></i> Notes</h3>
              {{ item.notes }}
            </div>
            {% endif %}
            {% if item.keywords.size > 0 %}
            <div class="gallery__item__caption__keywords mt-3 fw-lighter">
              <h3 class="h6"><i class="bi bi-tag d-inline"></i> Keywords</h3>
              {% for keyword in item.keywords %}
                <a href="#keyword-{{ keyword | slugify }}"
                  class="keyword-filter badge text-bg-light text-decoration-none fw-light me-1"
                  data-keyword="{{ keyword }}"
                  style="font-size: 0.7rem;">{{ keyword }}</a>
                {% endfor %}
            </div>
            {% endif %}
          </div>
          {% endif %}
        {% endcapture %}

        {% assign caption = caption_html | strip_newlines %}

        {% assign cover = item.images[0] %}
        {% assign cover_src = "/assets/bidassoa/" | append: cover %}

        <article class="gallery__item" data-keywords="{{ item.keywords | join: ',' }}" data-year="{{ item.year }}">

          <div class="gallery__item__cover">
            <a
              href="{{ cover_src }}"
              data-fancybox="all-bidassoa"
              data-caption="{{ caption | escape }}"
              class="gallery__item__cover__link">
              <img
                src="{{ cover_src }}"
                alt='"{{ item.title | default: item.alias | capitalize | escape}} • {{ item.year }}"'
                loading="lazy"
                class="gallery__item__cover__img">
            </a>
          </div><!-- /.gallery__item__cover -->

          <header class="gallery__item__header fw-light">
            <span class="gallery__item__title fw-lighter {% if item.alias %}--is-alias{% endif %}" {% if item.alias %}title="Alias" {% endif %}>"{{ item.title | default: item.alias }}"</span>
            <span class="gallery__item__year">{{ item.year }}</span>

            <ul class="gallery__item__meta list-unstyled">
              {% if item.alias %}<li class="gallery__item__alias d-none">Alias.</li>{% endif %}
              {% if item.notes != empty %}<li class="gallery__item__notas"><i class="bi bi-journal-text"></i></li>{% endif %}

              {% if item.images.size > 1%}<li class="gallery__item__gallery"><i class="bi bi-images"></i></li>{% endif %}

              {% if item.keywords.size > 0 %}
              <li class="gallery__item__keywords">
                <i class="bi bi-tags"></i>
                {% for keyword in item.keywords %}
                <a href="#keyword-{{ keyword | slugify }}"
                  class="keyword-filter badge text-bg-light text-decoration-none fw-light me-1"
                  data-keyword="{{ keyword }}"
                  style="font-size: 0.7rem;">{{ keyword }}</a>
                {% endfor %}
              </li>
              {% endif %}
            </ul>
          </header>

          {% if item.images.size > 1 %}
          <div class="gallery__item__gallery">
            {% for img in item.images offset:1 %}
            {% assign img_src = "/assets/bidassoa/" | append: img %}
            <a
              href="{{ img_src }}"
              data-fancybox="all-bidassoa"
              data-caption="{{ caption | escape }}"
              class=""></a>
            {% endfor %}
          </div><!-- /.gallery__item__gallery -->
          {% endif %}

        </article>
        {% endfor %}

        {% if items.size > 0 %}
      </section> <!-- /.bidassoa-year-grid -->
      {% endif %}

    </div>

  </div><!-- /.gallery__content  -->
</div>


<script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.0/dist/fancybox/fancybox.umd.js"></script>

<script>
  // Sistema de filtrado por keywords
  (function () {
    let activeFilters = new Set();

    // Leer filtros desde URL hash
    function loadFiltersFromHash() {
      const hash = window.location.hash.substring(1);
      if (!hash) {
        activeFilters.clear();
        return;
      }

      // Parsear keywords desde el hash: #keyword-variante,keyword-serigrafia
      if (hash.startsWith('keyword-')) {
        const keywords = hash.substring(8).split(',').map(k => decodeURIComponent(k));
        activeFilters = new Set(keywords);
      }
    }

    // Actualizar URL hash con filtros activos
    function updateHash() {
      if (activeFilters.size === 0) {
        history.replaceState(null, '', window.location.pathname + window.location.search);
      } else {
        const keywords = Array.from(activeFilters).map(k => encodeURIComponent(k)).join(',');
        history.replaceState(null, '', `#keyword-${keywords}`);
      }
    }

    // Aplicar filtros a la galería
    function applyFilters() {
      const items = document.querySelectorAll('.gallery__item');
      let visibleCount = 0;

      items.forEach(item => {
        if (activeFilters.size === 0) {
          item.style.display = '';
          visibleCount++;
          return;
        }

        const itemKeywords = item.dataset.keywords ? item.dataset.keywords.split(',') : [];

        // Un item es visible si tiene TODOS los keywords activos (AND logic)
        const hasAllFilters = Array.from(activeFilters).every(filter =>
          itemKeywords.includes(filter)
        );

        if (hasAllFilters) {
          item.style.display = '';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });

      // Ocultar años sin items visibles
      const years = document.querySelectorAll('.gallery__year');
      years.forEach(yearSection => {
        const visibleItems = yearSection.querySelectorAll('.gallery__item[style=""], .gallery__item:not([style*="display: none"])');
        yearSection.style.display = visibleItems.length > 0 ? '' : 'none';
      });

      updateActiveFiltersUI();
    }

    // Actualizar UI de filtros activos
    function updateActiveFiltersUI() {
      const clearBtn = document.getElementById('clear-filters');

      // Mostrar/ocultar botón de clear
      clearBtn.style.display = activeFilters.size > 0 ? 'block' : 'none';

      // Actualizar estado de keywords en la lista
      document.querySelectorAll('.keyword-filter').forEach(link => {
        const keyword = link.dataset.keyword;
        if (activeFilters.has(keyword)) {
          link.classList.remove('text-bg-light');
          link.classList.add('text-bg-secondary');
        } else {
          link.classList.remove('text-bg-secondary');
          link.classList.add('text-bg-light');
        }
      });
    }

    // Event listeners
    document.addEventListener('click', function (e) {
      // Click en keyword para filtrar
      if (e.target.closest('.keyword-filter')) {
        e.preventDefault();
        const link = e.target.closest('.keyword-filter');
        const keyword = link.dataset.keyword;

        if (activeFilters.has(keyword)) {
          activeFilters.delete(keyword);
        } else {
          activeFilters.add(keyword);
        }

        updateHash();
        applyFilters();
      }

      // Click en clear all
      if (e.target.closest('#clear-filters')) {
        e.preventDefault();
        activeFilters.clear();
        updateHash();
        applyFilters();
      }
    });

    // Cargar filtros al inicio
    window.addEventListener('load', function () {
      loadFiltersFromHash();
      applyFilters();
    });

    // Escuchar cambios en el hash
    window.addEventListener('hashchange', function () {
      loadFiltersFromHash();
      applyFilters();
    });
  })();

  // Fancybox
  Fancybox.bind("[data-fancybox]", {
    mainTpl: `
    <dialog class="fancybox__dialog">
      <div class="fancybox__container" tabindex="0" aria-label="{{MODAL}}">
          <div class="fancybox__backdrop"></div>
          <div class="row">
            <div class="col">
              <div class="fancybox__carousel"></div>
            </div>
            <div class="col bg-black text-white p-3" style="--bs-bg-opacity: .3;">
              <div class="fancybox__sidebar"></div>
            </div>
          </div>
      </div>
    </dialog>`,
    Carousel: {
      Toolbar: {
        parentEl: (toolbar) => {
          return document.querySelector('.fancybox__toolbar');
        },
        items: {
          toggleInfo: {
            tpl: `<button class="f-button" title="Toggle info"><svg><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></button>`,
            click: () => {
              document.querySelector('.fancybox__container').classList.toggle('has-sidebar');
            },
          },
        },
        display: {
          left: ["counter"],
          middle: [
            "zoomIn",
            "zoomOut",
            "toggle1to1",
            "rotateCCW",
            "rotateCW",
            "flipX",
            "flipY",
            "reset",
          ],
          right: ["toggleInfo", "thumbs", "close"],
        },
      },
    },

    Images: {
      zoom: true,
    },

    on: {
      "Carousel.ready Carousel.change": (fancybox) => {
        const slide = fancybox.getSlide();
        const triggerEl = slide.triggerEl;

        // Obtener el contenido del sidebar desde el atributo data-sidebar
        const sidebarContent = triggerEl ? triggerEl.getAttribute('data-caption') : '';

        // Insertar en el elemento del sidebar
        const sidebarEl = document.querySelector('.fancybox__sidebar');
        if (sidebarEl) {
          sidebarEl.innerHTML = sidebarContent || '';
        }
      },
    },


  });
</script>
