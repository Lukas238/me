<div id="gallery-bidassoa" class="gallery container-xxl">
  {% comment %}Ordenar items: primero por año (descendente, -1 primero), luego por título dentro de cada año{% endcomment %}
  {% assign items = "" | split: "" %}

  {% comment %}Obtener todos los años únicos ordenados{% endcomment %}
  {% assign all_years = site.data.bidassoa | map: 'year' | uniq | sort | reverse %}
  {% assign years = "" | split: "" %}
  {% assign has_undated = false %}

  {% for year in all_years %}
    {% if year == -1 %}
      {% assign has_undated = true %}
    {% else %}
      {% assign years = years | push: year %}
    {% endif %}
  {% endfor %}

  {% if has_undated %}
    {% assign years = years | unshift: -1 %}
  {% endif %}

  {% comment %}Procesar cada año en orden y ordenar items por título dentro de cada año{% endcomment %}
  {% for year in years %}
    {% assign year_items = site.data.bidassoa | where: "year", year %}

    {% comment %}Separar por título vs alias y ordenar{% endcomment %}
    {% assign items_with_title = "" | split: "" %}
    {% assign items_with_alias = "" | split: "" %}

    {% for item in year_items %}
      {% if item.title and item.title != "" %}
        {% assign items_with_title = items_with_title | push: item %}
      {% else %}
        {% assign items_with_alias = items_with_alias | push: item %}
      {% endif %}
    {% endfor %}

    {% assign items_with_title = items_with_title | sort: 'title' %}
    {% assign items_with_alias = items_with_alias | sort: 'alias' %}
    {% assign sorted_year_items = items_with_title | concat: items_with_alias %}

    {% assign items = items | concat: sorted_year_items %}
  {% endfor %}

  {% assign current_year = nil %}

  <!-- Recopilar todos los keywords únicos (AI + AI extra) -->
  {% assign all_keywords = "" | split: "" %}
  {% for item in items %}
  {% if item.keywords %}
  {% assign all_keywords = all_keywords | concat: item.keywords %}
  {% endif %}
  {% endfor %}
  {% assign unique_keywords = all_keywords | uniq | sort %}

  {% comment %}Agrupar keywords por categoría{% endcomment %}
  {% assign grouped_keywords = "" | split: "" %}
  {% assign ungrouped_keywords = "" | split: "" %}

  {% for keyword in unique_keywords %}
    {% if keyword contains "--" %}
      {% assign grouped_keywords = grouped_keywords | push: keyword %}
    {% else %}
      {% assign ungrouped_keywords = ungrouped_keywords | push: keyword %}
    {% endif %}
  {% endfor %}

  {% comment %}Crear estructura de grupos{% endcomment %}
  {% assign groups = "" | split: "" %}
  {% for keyword in grouped_keywords %}
    {% assign parts = keyword | split: "--" %}
    {% assign group = parts[0] %}
    {% unless groups contains group %}
      {% assign groups = groups | push: group %}
    {% endunless %}
  {% endfor %}
  {% assign groups = groups | sort %}

  <aside class="gallery__navFilters">
    <!-- Keywords disponibles -->
    <div class="mb-4">
      <div class="d-flex mb-3">
        <h5 class="mb-0">Keywords</h5>
        <button id="clear-filters" class="btn btn-sm btn-link text-muted p-0 ms-3" style="display: none;" title="Clear all filters">
          <i class="bi bi-trash"></i>
        </button>
      </div>
      <div id="keywords-list" class="d-flex flex-column gap-3">
        {% comment %}Keywords agrupadas - fluyen en línea{% endcomment %}
        <div class="keyword-groups">
          <div class="d-flex flex-wrap gap-2 align-items-baseline">
            {% for group in groups %}
              <a href="#keyword-_{{ group }}"
                class="keyword-filter fw-bold text-muted small text-decoration-none"
                data-keyword="_{{ group }}"
                style="cursor: pointer;">{{ group | capitalize }}:</a>
              {% for keyword in grouped_keywords %}
                {% assign parts = keyword | split: "--" %}
                {% if parts[0] == group %}
                  <a href="#keyword-{{ keyword | slugify }}"
                    class="keyword-filter badge text-bg-light text-decoration-none fw-light"
                    data-keyword="{{ keyword }}">{{ parts[1] }}</a>
                {% endif %}
              {% endfor %}
              {% unless forloop.last %}
                <span class="text-muted mx-1">•</span>
              {% endunless %}
            {% endfor %}
          </div>
        </div>

        {% comment %}Keywords sin grupo (ocultar los que empiezan con _){% endcomment %}
        {% assign visible_ungrouped = "" | split: "" %}
        {% for keyword in ungrouped_keywords %}
          {% unless keyword contains "_" %}
            {% assign visible_ungrouped = visible_ungrouped | push: keyword %}
          {% endunless %}
        {% endfor %}
        {% if visible_ungrouped.size > 0 %}
        <div class="keyword-group">
          <div class="d-flex flex-wrap gap-2">
            {% for keyword in visible_ungrouped %}
            <a href="#keyword-{{ keyword | slugify }}"
              class="keyword-filter badge text-bg-light text-decoration-none fw-light"
              data-keyword="{{ keyword }}">{{ keyword }}</a>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </aside>

  <div class="gallery__content d-flex">

    <aside class="gallery__navYears py-4 order-2 ps-4  pt-4">
      <nav id="navbar-years" class="sticky-top text-end">
        <h5>Years</h5>
        <ul class="fw-light ps-0 list-unstyled">
          {% for year in years %}
          <li class="ps-0"><a href="#year-{{ year }}">{% if year == -1 %}Sin fecha{% else %}{{ year }}{% endif %}</a></li>
          {% endfor %}
        </ul>
      </nav>
    </aside>

    <div class="gallery__grid flex-grow-1">

      {% for item in items %}

      {% if item.year != current_year %}
      {% if forloop.index0 > 0 %}
      </section> <!-- /.bidassoa-year-grid -->
      {% endif %}

      {% assign current_year = item.year %}


      <section id="year-{{ item.year }}" class="gallery__year">
        <header class="gallery__year__header d-flex justify-content-between">
          <h2 class="gallery__year__title fw-light">{% if current_year == -1 %}Sin fecha{% else %}{{ current_year }}{% endif %}</h2>
          <a href="#gallery-bidassoa" class="link-opacity-10 link-opacity-100-hover"><i class="bi bi-arrow-bar-up"></i>
            <div class="visually-hidden">Back to top</div>
          </a>
        </header>
        {% endif %}

        {% assign group_id = item.id | slugify %}

        {% capture caption_html %}
        <div class="gallery__item__caption">
          <div class="gallery__item__caption__title fw-lighter lead {% if item.alias %}--is-alias{% endif %}">"{% if item.title %}{{ item.title }}{% else %}{{ item.alias }}{% endif %}"{% if item.alias %} (alias){% endif %}</div>
          <div class="gallery__item__caption__year fw-lighter">{% if item.year == -1 %}Sin fecha{% else %}{{ item.year }}{% endif %}</div>
        </div>

          {% assign combined_keywords_size = 0 %}
          {% if item.keywords %}
            {% assign combined_keywords_size = item.keywords.size %}
          {% endif %}
          {% if  item.notes != "" or combined_keywords_size > 0  %}
          <div class="gallery__item__caption__meta">
            {% if item.notes != "" %}
            <div class="gallery__item__caption__notes mt-3 fw-lighter">
              <h3 class="h6"><i class="bi bi-journal-text d-inline"></i> Notes</h3>
              {{ item.notes }}
            </div>
            {% endif %}
            {% if combined_keywords_size > 0 %}
            <div class="gallery__item__caption__keywords mt-3 fw-lighter">
              <h3 class="h6"><i class="bi bi-tag d-inline"></i> Keywords</h3>
              {% comment %}Keywords ya están ordenados y unificados{% endcomment %}
              {% assign all_item_keywords = item.keywords | default: empty_array %}

              {% comment %}Agrupar por padres{% endcomment %}
              {% assign keyword_groups = "" | split: "" %}
              {% assign ungrouped = "" | split: "" %}
              {% assign processed_groups = "" | split: "" %}

              {% for keyword in all_item_keywords %}
                {% if keyword contains "--" %}
                  {% assign parts = keyword | split: "--" %}
                  {% assign parent = parts[0] %}
                  {% unless processed_groups contains parent %}
                    {% assign processed_groups = processed_groups | push: parent %}
                    {% assign keyword_groups = keyword_groups | push: parent %}
                  {% endunless %}
                {% else %}
                  {% assign ungrouped = ungrouped | push: keyword %}
                {% endif %}
              {% endfor %}

              {% comment %}Mostrar keywords sin grupo primero{% endcomment %}
              {% if ungrouped.size > 0 %}
                <div class="mb-1">
                  {% for keyword in ungrouped %}
                    <a href="#keyword-{{ keyword | slugify }}"
                      class="keyword-filter badge text-bg-light text-decoration-none fw-light me-1"
                      data-keyword="{{ keyword }}"
                      style="font-size: 0.7rem;">{{ keyword }}</a>
                  {% endfor %}
                </div>
              {% endif %}

              {% comment %}Mostrar grupos con título{% endcomment %}
              {% for group in keyword_groups %}
                <div class="mb-1">
                  <a href="#keyword-_{{ group }}"
                    class="keyword-filter text-muted text-decoration-none"
                    data-keyword="_{{ group }}"
                    style="cursor: pointer;">{{ group | capitalize }}:</a>
                  {% for keyword in all_item_keywords %}
                    {% if keyword contains "--" %}
                      {% assign parts = keyword | split: "--" %}
                      {% if parts[0] == group %}
                        <a href="#keyword-{{ keyword | slugify }}"
                          class="keyword-filter badge text-bg-light text-decoration-none fw-light me-1"
                          data-keyword="{{ keyword }}"
                          style="font-size: 0.7rem;">{{ parts[1] }}</a>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                </div>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          {% endif %}
        {% endcapture %}

        {% assign caption = caption_html | strip_newlines %}

        {% assign cover = item.images[0] %}
        {% assign cover_src = "/assets/bidassoa/" | append: cover %}

        {% assign combined_keywords = item.keywords | default: empty_array %}
        <article class="gallery__item" data-keywords="{{ combined_keywords | join: ',' }}" data-year="{{ item.year }}">

          <div class="gallery__item__cover" {% if item.width and item.height %}style="aspect-ratio: {{ item.width }} / {{ item.height }};"{% endif %}>
            <a
              href="{{ cover_src }}"
              data-fancybox="all-bidassoa"
              data-caption="{{ caption | escape }}"
              class="gallery__item__cover__link">
              <img
                src="{{ cover_src }}"
                alt="{{ item.title | default: item.alias | escape }} • {% if item.year == -1 %}Sin fecha{% else %}{{ item.year }}{% endif %}"
                loading="lazy"
                class="gallery__item__cover__img">
            </a>
          </div><!-- /.gallery__item__cover -->

          <header class="gallery__item__header fw-light">
            <span class="gallery__item__title fw-lighter {% if item.alias %}--is-alias{% endif %}" {% if item.alias %}title="Alias" {% endif %}>"{% if item.title %}{{ item.title }}{% else %}{{ item.alias }}{% endif %}"</span>
            <span class="gallery__item__year">{% if item.year == -1 %}Sin fecha{% else %}{{ item.year }}{% endif %}</span>

            <ul class="gallery__item__meta list-unstyled">
              {% if item.alias %}<li class="gallery__item__alias d-none">Alias.</li>{% endif %}
              {% if item.notes != empty %}<li class="gallery__item__notas"><i class="bi bi-journal-text"></i></li>{% endif %}

              {% if item.images.size > 1%}<li class="gallery__item__gallery"><i class="bi bi-images"></i></li>{% endif %}

              {% if combined_keywords_size > 0 %}
              <li class="gallery__item__keywords">
                {% comment %}Keywords ya están ordenados y unificados{% endcomment %}
                {% assign all_item_keywords = item.keywords | default: empty_array %}

                {% comment %}Agrupar por padres{% endcomment %}
                {% assign keyword_groups = "" | split: "" %}
                {% assign ungrouped = "" | split: "" %}
                {% assign processed_groups = "" | split: "" %}

                {% for keyword in all_item_keywords %}
                  {% if keyword contains "--" %}
                    {% assign parts = keyword | split: "--" %}
                    {% assign parent = parts[0] %}
                    {% unless processed_groups contains parent %}
                      {% assign processed_groups = processed_groups | push: parent %}
                      {% assign keyword_groups = keyword_groups | push: parent %}
                    {% endunless %}
                  {% else %}
                    {% assign ungrouped = ungrouped | push: keyword %}
                  {% endif %}
                {% endfor %}

                {% comment %}Mostrar keywords sin grupo primero{% endcomment %}
                {% if ungrouped.size > 0 %}
                  <div class="d-block">
                    {% for keyword in ungrouped %}
                      <a href="#keyword-{{ keyword | slugify }}"
                        class="keyword-filter badge text-bg-light text-decoration-none fw-light me-1"
                        data-keyword="{{ keyword }}"
                        style="font-size: 0.7rem;">{{ keyword }}</a>
                    {% endfor %}
                  </div>
                {% endif %}

                {% comment %}Mostrar grupos con título{% endcomment %}
                {% for group in keyword_groups %}
                  <div class="d-block">
                    <a href="#keyword-_{{ group }}"
                      class="keyword-filter text-muted text-decoration-none"
                      data-keyword="_{{ group }}"
                      style="cursor: pointer; font-size: 0.7rem; color: #6c757d !important;">{{ group | capitalize }}:</a>
                    {% for keyword in all_item_keywords %}
                      {% if keyword contains "--" %}
                        {% assign parts = keyword | split: "--" %}
                        {% if parts[0] == group %}
                          <a href="#keyword-{{ keyword | slugify }}"
                            class="keyword-filter badge text-bg-light text-decoration-none fw-light me-1"
                            data-keyword="{{ keyword }}"
                            style="font-size: 0.7rem;">{{ parts[1] }}</a>
                        {% endif %}
                      {% endif %}
                    {% endfor %}
                  </div>
                {% endfor %}
              </li>
              {% endif %}
            </ul>
          </header>

          {% if item.images.size > 1 %}
          <div class="gallery__item__gallery">
            {% for img in item.images offset:1 %}
            {% assign img_src = "/assets/bidassoa/" | append: img %}
            <a
              href="{{ img_src }}"
              data-fancybox="all-bidassoa"
              data-caption="{{ caption | escape }}"
              class=""></a>
            {% endfor %}
          </div><!-- /.gallery__item__gallery -->
          {% endif %}

        </article>
        {% endfor %}

        {% if items.size > 0 %}
      </section> <!-- /.bidassoa-year-grid -->
      {% endif %}

    </div>

  </div><!-- /.gallery__content  -->
</div>


<script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.0/dist/fancybox/fancybox.umd.js"></script>

<script>
  // Sistema de filtrado por keywords
  (function () {
    let activeFilters = new Set();

    // Leer filtros desde URL hash
    function loadFiltersFromHash() {
      const hash = window.location.hash.substring(1);
      if (!hash) {
        activeFilters.clear();
        return;
      }

      // Parsear keywords desde el hash: #keyword-variante,keyword-serigrafia
      if (hash.startsWith('keyword-')) {
        const keywords = hash.substring(8).split(',').map(k => decodeURIComponent(k));
        activeFilters = new Set(keywords);
      }
    }

    // Actualizar URL hash con filtros activos
    function updateHash() {
      if (activeFilters.size === 0) {
        history.replaceState(null, '', window.location.pathname + window.location.search);
      } else {
        const keywords = Array.from(activeFilters).map(k => encodeURIComponent(k)).join(',');
        history.replaceState(null, '', `#keyword-${keywords}`);
      }
    }

    // Aplicar filtros a la galería
    function applyFilters() {
      const items = document.querySelectorAll('.gallery__item');
      let visibleCount = 0;

      items.forEach(item => {
        if (activeFilters.size === 0) {
          item.style.display = '';
          visibleCount++;
          return;
        }

        const itemKeywords = item.dataset.keywords ? item.dataset.keywords.split(',') : [];

        // Un item es visible si tiene TODOS los keywords activos (AND logic)
        // Si el filtro empieza con _, buscar cualquier hijo de ese padre
        const hasAllFilters = Array.from(activeFilters).every(filter => {
          if (filter.startsWith('_')) {
            const parent = filter.substring(1);
            return itemKeywords.some(kw => kw.startsWith(parent + '--') || kw === filter);
          }
          return itemKeywords.includes(filter);
        });

        if (hasAllFilters) {
          item.style.display = '';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });

      // Ocultar años sin items visibles
      const years = document.querySelectorAll('.gallery__year');
      years.forEach(yearSection => {
        const visibleItems = yearSection.querySelectorAll('.gallery__item[style=""], .gallery__item:not([style*="display: none"])');
        yearSection.style.display = visibleItems.length > 0 ? '' : 'none';
      });

      updateActiveFiltersUI();
    }

    // Actualizar UI de filtros activos
    function updateActiveFiltersUI() {
      const clearBtn = document.getElementById('clear-filters');

      // Mostrar/ocultar botón de clear
      clearBtn.style.display = activeFilters.size > 0 ? 'block' : 'none';

      // Actualizar estado de keywords en la lista
      document.querySelectorAll('.keyword-filter').forEach(link => {
        const keyword = link.dataset.keyword;
        const isActive = activeFilters.has(keyword);

        if (keyword.startsWith('_')) {
          // Estilo para keywords padre
          if (isActive) {
            link.style.fontWeight = 'bold';
            link.style.color = '#000';
          } else {
            link.style.fontWeight = 'bold';
            link.style.color = '';
          }
        } else {
          // Estilo para keywords normales
          if (isActive) {
            link.classList.remove('text-bg-light');
            link.classList.add('text-bg-secondary');
          } else {
            link.classList.remove('text-bg-secondary');
            link.classList.add('text-bg-light');
          }
        }
      });
    }

    // Event listeners
    document.addEventListener('click', function (e) {
      // Click en keyword para filtrar
      if (e.target.closest('.keyword-filter')) {
        e.preventDefault();
        const link = e.target.closest('.keyword-filter');
        const keyword = link.dataset.keyword;

        // Si se presiona Ctrl/Cmd, comportamiento aditivo (agregar/quitar)
        if (e.ctrlKey || e.metaKey) {
          if (activeFilters.has(keyword)) {
            activeFilters.delete(keyword);
          } else {
            activeFilters.add(keyword);
          }
        } else {
          // Sin Ctrl/Cmd, seleccionar solo este keyword
          if (activeFilters.size === 1 && activeFilters.has(keyword)) {
            // Si ya es el único seleccionado, deseleccionar
            activeFilters.clear();
          } else {
            // Reemplazar con solo este keyword
            activeFilters.clear();
            activeFilters.add(keyword);
          }
        }

        updateHash();
        applyFilters();
      }

      // Click en clear all
      if (e.target.closest('#clear-filters')) {
        e.preventDefault();
        activeFilters.clear();
        updateHash();
        applyFilters();
      }
    });

    // Cargar filtros al inicio
    window.addEventListener('load', function () {
      loadFiltersFromHash();
      applyFilters();
    });

    // Escuchar cambios en el hash
    window.addEventListener('hashchange', function () {
      loadFiltersFromHash();
      applyFilters();
    });
  })();

  // Fancybox
  Fancybox.bind("[data-fancybox]", {
    mainTpl: `
    <dialog class="fancybox__dialog">
      <div class="fancybox__container" tabindex="0" aria-label="{{MODAL}}">
          <div class="fancybox__backdrop"></div>
          <div class="row">
            <div class="col">
              <div class="fancybox__carousel"></div>
            </div>
            <div class="col bg-black text-white p-3" style="--bs-bg-opacity: .3;">
              <div class="fancybox__sidebar"></div>
            </div>
          </div>
      </div>
    </dialog>`,
    Carousel: {
      Toolbar: {
        parentEl: (toolbar) => {
          return document.querySelector('.fancybox__toolbar');
        },
        items: {
          toggleInfo: {
            tpl: `<button class="f-button" title="Toggle info"><svg><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></button>`,
            click: () => {
              document.querySelector('.fancybox__container').classList.toggle('has-sidebar');
            },
          },
        },
        display: {
          left: ["counter"],
          middle: [
            "zoomIn",
            "zoomOut",
            "toggle1to1",
            "rotateCCW",
            "rotateCW",
            "flipX",
            "flipY",
            "reset",
          ],
          right: ["toggleInfo", "thumbs", "close"],
        },
      },
    },

    Images: {
      zoom: true,
    },

    on: {
      "Carousel.ready Carousel.change": (fancybox) => {
        const slide = fancybox.getSlide();
        const triggerEl = slide.triggerEl;

        // Obtener el contenido del sidebar desde el atributo data-sidebar
        const sidebarContent = triggerEl ? triggerEl.getAttribute('data-caption') : '';

        // Insertar en el elemento del sidebar
        const sidebarEl = document.querySelector('.fancybox__sidebar');
        if (sidebarEl) {
          sidebarEl.innerHTML = sidebarContent || '';
        }
      },
    },


  });
</script>
